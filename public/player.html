<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brawl Stars Profile</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Bangers&display=swap");

      body {
        font-family: "Bangers", cursive;
        background-color: #1e1e1e;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }

      .profile {
        display: flex;
        border: 5px solid #bb86fc;
        border-radius: 15px;
        overflow: hidden;
        background-color: #2c2c2c;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
      }

      .left-section,
      .right-section {
        padding: 20px;
      }

      .left-section {
        text-align: center;
        background: linear-gradient(135deg, #bb86fc, #03dac6);
        border-right: 5px solid #bb86fc;
      }

      .left-section .brawler-image {
        width: 200px;
        height: auto;
        border: 3px solid #bb86fc;
        border-radius: 10px;
      }

      .favorite-brawler {
        margin-top: 10px;
        font-size: 18px;
        color: #ffffff;
      }

      .brawler-name {
        font-size: 28px;
        font-weight: bold;
        color: #ffffff;
      }

      .right-section {
        background-color: #3c3c3c;
        width: 400px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #bb86fc;
        padding-bottom: 10px;
      }

      .username {
        font-size: 28px;
        font-weight: bold;
        color: #bb86fc;
      }

      .user-tag {
        font-size: 16px;
        color: #ccc;
      }

      .trophies {
        font-size: 20px;
        color: #ffffff;
      }

      .stats {
        margin-top: 20px;
      }

      .stat {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        background-color: #4c4c4c;
        padding: 10px;
        border-radius: 10px;
      }

      .stat-title {
        font-size: 16px;
        color: #bb86fc;
      }

      .stat-value {
        font-size: 18px;
        color: #ffffff;
      }

      .club {
        margin-top: 20px;
        padding: 10px;
        background-color: #4c4c4c;
        border-radius: 10px;
      }

      .club-name {
        font-size: 20px;
        font-weight: bold;
        color: #bb86fc;
      }

      .member-status {
        font-size: 16px;
        color: #ccc;
      }

      .battle-card {
        margin-top: 20px;
      }

      .battle-title {
        font-size: 20px;
        font-weight: bold;
        color: #bb86fc;
      }

      .cards {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }

      .cards img {
        width: 80px;
        height: 80px;
        border: 3px solid #bb86fc;
        border-radius: 10px;
      }

      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #3c3c3c;
        padding: 20px;
        border: 5px solid #bb86fc;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .loading-container h1 {
        margin: 0;
        padding: 0;
        font-size: 36px;
        color: #bb86fc;
      }

      .loading-spinner {
        margin-top: 20px;
        width: 80px;
        height: 80px;
        border: 10px solid #bb86fc;
        border-top: 10px solid #03dac6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="loading-container" id="loading">
      <h1>Loading...</h1>
      <div class="loading-spinner"></div>
    </div>
    <div class="profile hidden" id="profile">
      <div class="left-section">
        <img src="path_to_your_emz_image.png" alt="EMZ" class="brawler-image" />
        <div class="favorite-brawler">MY FAVORITE BRAWLER</div>
        <div class="brawler-name"></div>
      </div>
      <div class="right-section">
        <div class="header">
          <div class="username"></div>
          <div class="user-tag"></div>
          <div class="trophies">
            <span class="current-trophies"></span>/<span class="next-milestone"></span>
          </div>
        </div>
        <div class="stats">
          <div class="stat">
            <div class="stat-title">HIGHEST TROPHIES</div>
            <div class="stat-value max-trophies"></div>
          </div>
          <div class="stat">
            <div class="stat-title">3V3 VICTORIES</div>
            <div class="stat-value trios"></div>
          </div>
          <div class="stat">
            <div class="stat-title">WIN STREAK</div>
            <div class="stat-value"></div>
          </div>
        </div>
        <div class="club">
          <div class="club-name"></div>
          <div class="member-status"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const pathParts = window.location.pathname.split("/");
        const playerTag = pathParts[pathParts.length - 1];

        try {
          const response = await fetch(`/api/player/${playerTag}`);
          const playerData = await response.json();

          let highestTrophieBrawler;
          const brawlers = playerData.brawlers;
          brawlers.forEach((brawler) => {
            if (!highestTrophieBrawler) {
              highestTrophieBrawler = brawler;
            }

            if (brawler.trophies > highestTrophieBrawler.trophies) {
              highestTrophieBrawler = brawler;
            }
          });

          // set all the stats
          document.querySelector(".brawler-name").innerText = highestTrophieBrawler.name;
          document.querySelector(".username").innerText = playerData.name;
          document.querySelector(".user-tag").innerText = `#${playerData.tag}`;
          document.querySelector(".current-trophies").innerText = playerData.trophies;
          document.querySelector(".max-trophies").innerText = playerData.highestTrophies;
          document.querySelector(".trios").innerText = playerData["3vs3Victories"];

          // get the club name and remove the <> and anything inside of them from it
          const clubName = playerData.club.name.replace(/<[^>]*>/g, "");
          document.querySelector(".club-name").innerText = clubName;

          // get club tag and remove the #
          const clubTag = playerData.club.tag.replace("#", "");
          const clubResponse = await fetch(`/api/club/${clubTag}/members`);
          const clubData = await clubResponse.json();
          const member = clubData.items.find((member) => member.tag === playerData.tag);
          document.querySelector(".member-status").innerText = member.role;

          // get current trophies
          const currentTrophies = parseInt(document.querySelector(".current-trophies").textContent, 10);

          // calculate next milestone
          let nextMilestone = 0;
          const base = Math.floor(currentTrophies / 1000) * 1000;
          const remainder = currentTrophies % 1000;

          if (remainder === 0) {
            nextMilestone = currentTrophies + 200;
          } else if (remainder < 200) {
            nextMilestone = base + 200;
          } else if (remainder < 500) {
            nextMilestone = base + 500;
          } else if (remainder < 700) {
            nextMilestone = base + 700;
          } else if (remainder < 900) {
            nextMilestone = base + 900;
          } else {
            nextMilestone = base + 1000;
          }

          // update next-milestone
          document.querySelector(".next-milestone").textContent = nextMilestone;

          // Hide the loading screen and show the profile
          document.getElementById("loading").classList.add("hidden");
          document.getElementById("profile").classList.remove("hidden");
        } catch (error) {
          console.log(error);
        }
      });
    </script>
  </body>
</html>
